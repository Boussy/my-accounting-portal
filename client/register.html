<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inscription | FinExpert Comptabilité</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .bg-custom-red {
      background-color: #9a1f40;
    }
    .text-custom-red {
      color: #9a1f40;
    }
    .border-custom-red {
      border-color: #9a1f40;
    }
    .hover-custom-red:hover {
      background-color: #7a1930;
    }
    .gradient-header {
      background: linear-gradient(to right, #9a1f40, #c13c54);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #f5f7fa 0%, #eef2f7 100%);
    }
    .shadow-custom {
      box-shadow: 0 10px 25px -5px rgba(154, 31, 64, 0.1), 0 8px 10px -6px rgba(154, 31, 64, 0.05);
    }
    .focus-custom:focus {
      border-color: #9a1f40;
      box-shadow: 0 0 0 3px rgba(154, 31, 64, 0.2);
    }
    .tab-active {
      border-bottom: 3px solid #9a1f40;
      color: #9a1f40;
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen gradient-bg">
  <div class="w-full max-w-md px-6 py-8">
    <div class="mb-8 text-center">
      <div class="flex items-center justify-center mb-4">
        <i class="fas fa-chart-line text-4xl text-custom-red mr-3"></i>
        <h1 class="text-2xl font-bold text-gray-800">FinExpert Comptabilité</h1>
      </div>
      <p class="text-gray-600">Votre partenaire de confiance en comptabilité</p>
    </div>
    
    <div class="bg-white rounded-lg shadow-custom w-full overflow-hidden">
      <div class="p-8">
        <h2 class="text-2xl font-semibold mb-6 text-center text-custom-red">
          <i class="fas fa-user-plus mr-2"></i>Créer un compte
        </h2>
    <form id="register-form">
      <!-- Email -->
      <div class="mb-5">
        <label class="block mb-2 text-sm font-medium text-gray-700">Email</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-envelope text-gray-400"></i>
          </div>
          <input type="email" id="email" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-red focus:border-custom-red transition" placeholder="votre@email.com" required>
        </div>
        <p id="email-format-error" class="text-red-600 text-xs mt-1 hidden">Veuillez entrer une adresse email valide</p>
      </div>
      
      <!-- Nom -->
      <div class="mb-5">
        <label class="block mb-2 text-sm font-medium text-gray-700">Nom(s)</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-user text-gray-400"></i>
          </div>
          <input type="text" id="nom" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-red focus:border-custom-red transition" placeholder="Dupont" required>
        </div>
      </div>
      
      <!-- Prénom -->
      <div class="mb-5">
        <label class="block mb-2 text-sm font-medium text-gray-700">Prénom(s)</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-user text-gray-400"></i>
          </div>
          <input type="text" id="prenom" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-red focus:border-custom-red transition" placeholder="Jean Pierre" required>
        </div>
      </div>
      
      <!-- Entreprise -->
      <div class="mb-5">
        <label class="block mb-2 text-sm font-medium text-gray-700">Nom de l'entreprise</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-building text-gray-400"></i>
          </div>
          <input type="text" id="entreprise" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-red focus:border-custom-red transition" placeholder="Entreprise SAS" required>
        </div>
      </div>
      
      <!-- Adresse -->
      <div class="mb-5">
        <label class="block mb-2 text-sm font-medium text-gray-700">Adresse</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-map-marker-alt text-gray-400"></i>
          </div>
          <input type="text" id="adresse" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-red focus:border-custom-red transition" placeholder="123 rue des Entreprises" required>
        </div>
      </div>
      
      <!-- Numéro de téléphone -->
      <div class="mb-5">
        <label class="block mb-2 text-sm font-medium text-gray-700">Numéro de téléphone</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-phone text-gray-400"></i>
          </div>
          <input type="tel" id="numero" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-red focus:border-custom-red transition" placeholder="06 12 34 56 78" required>
        </div>
      </div>
      
      <!-- Mot de passe -->
      <div class="mb-5">
        <label class="block mb-2 text-sm font-medium text-gray-700">Mot de passe</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-lock text-gray-400"></i>
          </div>
          <input type="password" id="password" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-red focus:border-custom-red transition" placeholder="********" required>
        </div>
        <div class="mt-2 p-3 bg-gray-50 rounded-md border border-gray-200">
          <p class="text-xs text-gray-500 font-medium mb-1">Le mot de passe doit contenir :</p>
          <ul class="text-xs text-gray-500 list-disc pl-4 space-y-1">
            <li id="length-check" class="text-red-500">Au moins 8 caractères</li>
            <li id="uppercase-check" class="text-red-500">Au moins une lettre majuscule</li>
            <li id="lowercase-check" class="text-red-500">Au moins une lettre minuscule</li>
            <li id="number-check" class="text-red-500">Au moins un chiffre</li>
            <li id="special-check" class="text-red-500">Au moins un caractère spécial (!@#$%^&*)</li>
            <li id="space-check" class="text-red-500">Pas d'espaces</li>
          </ul>
        </div>
      </div>
      
      <!-- Confirmation mot de passe -->
      <div class="mb-5">
        <label class="block mb-2 text-sm font-medium text-gray-700">Confirmer le mot de passe</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-lock text-gray-400"></i>
          </div>
          <input type="password" id="confirm-password" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-red focus:border-custom-red transition" placeholder="********" required>
        </div>
        <p id="password-match-error" class="text-red-600 text-xs mt-1 hidden">Les mots de passe ne correspondent pas</p>
      </div>
      
      <!-- Cases à cocher RGPD et CGU -->
      <div class="mb-5">
        <div class="flex items-start mb-3">
          <div class="flex items-center h-5">
            <input id="rgpd" type="checkbox" class="w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-custom-red" required>
          </div>
          <label for="rgpd" class="ml-2 text-sm font-medium text-gray-700">
            J'accepte la <a href="rgpd.html" target="_blank" class="text-custom-red hover:underline">politique de confidentialité</a> et le traitement de mes données personnelles
          </label>
        </div>
        <div class="flex items-start">
          <div class="flex items-center h-5">
            <input id="cgu" type="checkbox" class="w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-custom-red" required>
          </div>
          <label for="cgu" class="ml-2 text-sm font-medium text-gray-700">
            J'accepte les <a href="cgu.html" target="_blank" class="text-custom-red hover:underline">conditions générales d'utilisation</a>
          </label>
        </div>
      </div>
      
      <!-- Rôle -->
      <div class="mb-6">
        <label class="block mb-2 text-sm font-medium text-gray-700">Rôle</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-user-tag text-gray-400"></i>
          </div>
          <select id="role" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-red focus:border-custom-red transition">
            <option value="client">Client</option>
            <option value="professionnel">Professionnel</option>
          </select>
        </div>
      </div>

      <button type="submit" class="w-full bg-custom-red hover:bg-red-700 text-white py-3 px-4 rounded-md transition-colors duration-200 flex items-center justify-center">
        <i class="fas fa-user-plus mr-2"></i> S'inscrire
      </button>
    </form>
    <p id="message" class="text-sm text-center mt-4 text-green-600"></p>
    
    <div class="mt-6 text-center">
      <p class="text-gray-600 text-sm">Vous avez déjà un compte ?</p>
      <a href="login.html" class="text-custom-red hover:underline text-sm font-medium">Se connecter</a>
    </div>
  </div>
  
  <div class="mt-6 text-center text-sm text-gray-600">
    <p>© 2025 FinExpert Comptabilité. Tous droits réservés.</p>
    <div class="mt-2 flex justify-center space-x-4">
      <a href="#" class="hover:text-custom-red transition">Assistance</a>
      <a href="rgpd.html" target="_blank" class="hover:text-custom-red transition">Politique de confidentialité</a>
      <a href="cgu.html" target="_blank" class="hover:text-custom-red transition">CGU</a>
    </div>
  </div>

  <script>
    // Fonction de validation d'email
    function validateEmail(email) {
      // Expression régulière avancée pour la validation d'email
      const emailRegex = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return emailRegex.test(email);
    }

    // Validation à la saisie de l'email
    const emailInput = document.getElementById('email');
    emailInput.addEventListener('blur', function() {
      const emailError = document.getElementById('email-format-error');
      if (this.value && !validateEmail(this.value)) {
        emailError.classList.remove('hidden');
        this.classList.add('border-red-500');
        this.classList.remove('focus:border-custom-red');
        this.classList.add('focus:border-red-500');
      } else {
        emailError.classList.add('hidden');
        this.classList.remove('border-red-500');
        this.classList.add('focus:border-custom-red');
        this.classList.remove('focus:border-red-500');
      }
    });

    // Rétablir la bordure normale quand l'utilisateur commence à saisir à nouveau
    emailInput.addEventListener('focus', function() {
      this.classList.remove('border-red-500');
      this.classList.add('focus:border-custom-red');
      this.classList.remove('focus:border-red-500');
    });
    
    // Validation de la force du mot de passe en temps réel
    const passwordInput = document.getElementById('password');
    const lengthCheck = document.getElementById('length-check');
    const uppercaseCheck = document.getElementById('uppercase-check');
    const lowercaseCheck = document.getElementById('lowercase-check');
    const numberCheck = document.getElementById('number-check');
    const specialCheck = document.getElementById('special-check');
    const spaceCheck = document.getElementById('space-check');
    
    function updatePasswordStrength(password) {
      // Vérifier la longueur
      if (password.length >= 8) {
        lengthCheck.classList.remove('text-red-500');
        lengthCheck.classList.add('text-green-500');
      } else {
        lengthCheck.classList.remove('text-green-500');
        lengthCheck.classList.add('text-red-500');
      }
      
      // Vérifier les majuscules
      if (/[A-Z]/.test(password)) {
        uppercaseCheck.classList.remove('text-red-500');
        uppercaseCheck.classList.add('text-green-500');
      } else {
        uppercaseCheck.classList.remove('text-green-500');
        uppercaseCheck.classList.add('text-red-500');
      }
      
      // Vérifier les minuscules
      if (/[a-z]/.test(password)) {
        lowercaseCheck.classList.remove('text-red-500');
        lowercaseCheck.classList.add('text-green-500');
      } else {
        lowercaseCheck.classList.remove('text-green-500');
        lowercaseCheck.classList.add('text-red-500');
      }
      
      // Vérifier les chiffres
      if (/\d/.test(password)) {
        numberCheck.classList.remove('text-red-500');
        numberCheck.classList.add('text-green-500');
      } else {
        numberCheck.classList.remove('text-green-500');
        numberCheck.classList.add('text-red-500');
      }
      
      // Vérifier les caractères spéciaux
      if (/[\W_]/.test(password)) {
        specialCheck.classList.remove('text-red-500');
        specialCheck.classList.add('text-green-500');
      } else {
        specialCheck.classList.remove('text-green-500');
        specialCheck.classList.add('text-red-500');
      }
      
      // Vérifier les espaces
      if (!/\s/.test(password)) {
        spaceCheck.classList.remove('text-red-500');
        spaceCheck.classList.add('text-green-500');
      } else {
        spaceCheck.classList.remove('text-green-500');
        spaceCheck.classList.add('text-red-500');
      }
    }
    
    // Mettre à jour l'indicateur de force du mot de passe lors de la saisie
    passwordInput.addEventListener('input', function() {
      updatePasswordStrength(this.value);
    });

    const form = document.getElementById('register-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const role = document.getElementById('role').value;
      const nom = document.getElementById('nom').value;
      const prenom = document.getElementById('prenom').value;
      const entreprise = document.getElementById('entreprise').value;
      const adresse = document.getElementById('adresse').value;
      const numero = document.getElementById('numero').value;
      const rgpd_accepted = document.getElementById('rgpd').checked;
      const cgu_accepted = document.getElementById('cgu').checked;

      // Réinitialiser les messages d'erreur
      document.getElementById('message').innerHTML = '';
      document.getElementById('password-match-error').classList.add('hidden');
      document.getElementById('email-format-error').classList.add('hidden');

      // Validation du mot de passe
      if (password !== confirmPassword) {
        document.getElementById('password-match-error').classList.remove('hidden');
        return;
      }

      // Validation du format de l'email
      if (!validateEmail(email)) {
        document.getElementById('email-format-error').classList.remove('hidden');
        document.getElementById('email').classList.add('border-red-500');
        return;
      }
      
      // Validation de la force du mot de passe côté client
      const isPasswordStrong = 
        password.length >= 8 && 
        /[A-Z]/.test(password) && 
        /[a-z]/.test(password) && 
        /\d/.test(password) && 
        /[\W_]/.test(password) && 
        !/\s/.test(password);
        
      if (!isPasswordStrong) {
        document.getElementById('message').innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i> Veuillez respecter toutes les exigences de mot de passe.';
        document.getElementById('message').classList.remove('text-gray-600', 'text-green-600');
        document.getElementById('message').classList.add('text-red-600');
        return;
      }

      // Afficher un indicateur de chargement
      document.getElementById('message').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Traitement en cours...';
      document.getElementById('message').classList.remove('text-red-600', 'text-green-600');
      document.getElementById('message').classList.add('text-gray-600');
      
      // Vérification des cases à cocher obligatoires
      if (!rgpd_accepted || !cgu_accepted) {
        document.getElementById('message').innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i> Vous devez accepter les CGU et la politique de confidentialité pour continuer.';
        document.getElementById('message').classList.remove('text-gray-600', 'text-green-600');
        document.getElementById('message').classList.add('text-red-600');
        return;
      }
        
      // Vérification des champs obligatoires
      if (role === 'client' && (!nom || !prenom || !entreprise || !adresse || !numero)) {
        document.getElementById('message').innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i> Tous les champs sont obligatoires.';
        document.getElementById('message').classList.remove('text-gray-600', 'text-green-600');
        document.getElementById('message').classList.add('text-red-600');
        return;
      }
      
      try {
        // Définir l'URL du backend - modifiable en fonction de l'environnement
        const API_URL = 'http://localhost:3000';
        
        console.log('Tentative de connexion au serveur:', API_URL);
        
        // Tester la connexion au serveur avant d'envoyer les données
        try {
          const pingResponse = await fetch(`${API_URL}/api/auth`, { 
            method: 'HEAD',
            mode: 'cors',
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' }
          });
          console.log('Ping serveur:', pingResponse.status ? 'OK' : 'Erreur');
        } catch (pingError) {
          console.error('Erreur lors du ping serveur:', pingError);
          // Continuer malgré l'erreur de ping
        }
        
        const res = await fetch(`${API_URL}/api/auth/register`, {
          method: 'POST',
          mode: 'cors',
          cache: 'no-cache',
          credentials: 'same-origin',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ 
            email, 
            password, 
            role, 
            nom, 
            prenom, 
            entreprise, 
            adresse, 
            numero, 
            rgpd_accepted, 
            cgu_accepted 
          })
        });

        // Si la réponse est reçue, tentative de parser le JSON
        let data;
        try {
          data = await res.json();
          console.log('Réponse serveur:', data);
        } catch (jsonError) {
          console.error('Erreur lors du parsing JSON:', jsonError);
          throw new Error('Réponse invalide du serveur');
        }
        
        if (res.ok) {
          document.getElementById('message').innerHTML = '<i class="fas fa-check-circle mr-2"></i> Inscription réussie. Vous pouvez vous connecter.';
          document.getElementById('message').classList.remove('text-gray-600', 'text-red-600');
          document.getElementById('message').classList.add('text-green-600');
          form.reset();
          // Rediriger vers la page de connexion après 2 secondes
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        } else {
          let errorMsg = 'Erreur lors de l\'inscription.';
          
          if (data.message) {
            if (data.message.includes('déjà utilisé')) {
              errorMsg = 'Cette adresse email est déjà utilisée. Veuillez en choisir une autre ou vous connecter.';
            } else if (data.message.includes('Format d\'email')) {
              errorMsg = 'Le format de l\'email est invalide. Veuillez vérifier votre adresse email.';
            } else if (data.message.includes('manquants')) {
              errorMsg = 'Veuillez remplir tous les champs obligatoires.';
            } else {
              errorMsg = data.message;
            }
          }
          
          document.getElementById('message').innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> ${errorMsg}`;
          document.getElementById('message').classList.remove('text-gray-600', 'text-green-600');
          document.getElementById('message').classList.add('text-red-600');
        }
      } catch (err) {
        console.error('Erreur lors de la requête:', err);
        document.getElementById('message').innerHTML = `<i class="fas fa-times-circle mr-2"></i> Erreur réseau: ${err.message || 'Impossible de connecter au serveur'}. Assurez-vous que le serveur est en cours d'exécution.<br><small class="block mt-1">Exécutez le script demarrer_serveur.sh pour lancer le serveur.</small>`;
        document.getElementById('message').classList.remove('text-gray-600', 'text-green-600');
        document.getElementById('message').classList.add('text-red-600');
      }
    });
  </script>
</body>
</html>
